name: Daily Cleanup

on:
  schedule:
    # Run daily at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain (1-30)'
        required: false
        default: '7'
      environment:
        description: 'Environment to clean'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  cleanup-staging:
    if: github.event_name == 'schedule' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    env:
      STAGING_SUPABASE_URL: https://htltgvowrzvdnpmbxufu.supabase.co
      STAGING_ADMIN_TOKEN: ${ 49f810460176b146e0566f7662d5e68909ef48e59e904975cc563fdcd3643ec7 }
      RETENTION_DAYS_INPUT: ${{ github.event.inputs.retention_days || '7' }}

    steps:
      - name: Cleanup staging database
        run: |
          set -euo pipefail

          RETENTION_DAYS="${RETENTION_DAYS_INPUT:-7}"

          # Normalize URL and token (CRITICAL FIX)
          BASE_URL="$(printf '%s' "${STAGING_SUPABASE_URL}" | tr -d '\r\n' | xargs)"
          BASE_URL="${BASE_URL%/}"
          ADMIN_TOKEN="$(printf '%s' "${STAGING_ADMIN_TOKEN}" | tr -d '\r\n' | xargs)"

          if [ -z "$BASE_URL" ]; then
            echo "::error::STAGING_SUPABASE_URL is empty"
            exit 1
          fi

          if [ -z "$ADMIN_TOKEN" ]; then
            echo "::error::STAGING_ADMIN_TOKEN is empty"
            exit 1
          fi

          echo "Cleaning up staging (retention: ${RETENTION_DAYS} days)..."
          echo "Cleanup URL: ${BASE_URL}/functions/v1/admin/cleanup"

          # ---- TOKEN VALIDATION STEP ----
          echo "Validating admin token..."
          STATS_RESPONSE="$(curl -sS -w "\n%{http_code}" \
            -H "x-admin-token: ${ADMIN_TOKEN}" \
            "${BASE_URL}/functions/v1/admin/stats")"

          STATS_CODE="$(echo "$STATS_RESPONSE" | tail -n1)"
          STATS_BODY="$(echo "$STATS_RESPONSE" | sed '$d')"

          if [ "$STATS_CODE" != "200" ]; then
            echo "::error::Admin token validation failed (${STATS_CODE})"
            echo "$STATS_BODY"
            exit 1
          fi

          # ---- CLEANUP ----
          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST \
            "${BASE_URL}/functions/v1/admin/cleanup" \
            -H "Content-Type: application/json" \
            -H "x-admin-token: ${ADMIN_TOKEN}" \
            -d "{\"retentionDays\": ${RETENTION_DAYS}}")"

          HTTP_CODE="$(echo "$RESPONSE" | tail -n1)"
          BODY="$(echo "$RESPONSE" | sed '$d')"

          echo "Response: $BODY"
          echo "Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Cleanup failed with status $HTTP_CODE"
            exit 1
          fi

          DELETED_RUNS="$(echo "$BODY" | jq -r '.deleted.runs // 0')"
          DELETED_EVENTS="$(echo "$BODY" | jq -r '.deleted.events // 0')"
          DELETED_PATCHES="$(echo "$BODY" | jq -r '.deleted.patches // 0')"
          DELETED_RATE_LIMITS="$(echo "$BODY" | jq -r '.deleted.rateLimits // 0')"

          echo "::notice::Staging cleanup complete â†’ \
          runs=$DELETED_RUNS, events=$DELETED_EVENTS, patches=$DELETED_PATCHES, rate_limits=$DELETED_RATE_LIMITS"

  cleanup-production:
    if: github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    env:
      PROD_SUPABASE_URL: https://htltgvowrzvdnpmbxufu.supabase.co
      PROD_ADMIN_TOKEN: ${49f810460176b146e0566f7662d5e68909ef48e59e904975cc563fdcd3643ec7}
      RETENTION_DAYS_INPUT: ${{ github.event.inputs.retention_days || '7' }}

    steps:
      - name: Cleanup production database
        run: |
          set -euo pipefail

          RETENTION_DAYS="${RETENTION_DAYS_INPUT:-7}"

          BASE_URL="$(printf '%s' "${PROD_SUPABASE_URL}" | tr -d '\r\n' | xargs)"
          BASE_URL="${BASE_URL%/}"
          ADMIN_TOKEN="$(printf '%s' "${PROD_ADMIN_TOKEN}" | tr -d '\r\n' | xargs)"

          if [ -z "$BASE_URL" ] || [ -z "$ADMIN_TOKEN" ]; then
            echo "::error::Production secrets missing"
            exit 1
          fi

          echo "Cleaning up production (retention: ${RETENTION_DAYS} days)..."

          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST \
            "${BASE_URL}/functions/v1/admin/cleanup" \
            -H "Content-Type: application/json" \
            -H "x-admin-token: ${ADMIN_TOKEN}" \
            -d "{\"retentionDays\": ${RETENTION_DAYS}}")"

          HTTP_CODE="$(echo "$RESPONSE" | tail -n1)"
          BODY="$(echo "$RESPONSE" | sed '$d')"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Production cleanup failed ($HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

          echo "::notice::Production cleanup successful"
