name: Daily Cleanup (Staging)

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain'
        required: false
        default: '7'

jobs:
  cleanup-staging:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: https://htltgvowrzvdnpmbxufu.supabase.co
      RETENTION_DAYS: ${{ github.event.inputs.retention_days || '7' }}
      ADMIN_TOKEN: ${{ secrets.STAGING_ADMIN_TOKEN }}

    steps:
      - name: Debug token shape (safe)
        run: |
          set -euo pipefail

          if [ -z "${ADMIN_TOKEN:-}" ]; then
            echo "::error::STAGING_ADMIN_TOKEN is empty (secret not found or not accessible)"
            exit 1
          fi

          # Print only safe metadata (no token)
          echo "Token length: ${#ADMIN_TOKEN}"
          echo -n "${ADMIN_TOKEN}" | sha256sum | awk '{print "Token sha256: " $1}'

          # Detect hidden whitespace/newlines (does not reveal token)
          printf '%s' "${ADMIN_TOKEN}" | od -An -t x1 | tail -n 1 | awk '{print "Last bytes (hex): " $0}'

      - name: Call cleanup
        run: |
          set -euo pipefail

          CLEANUP_URL="${SUPABASE_URL%/}/functions/v1/admin/cleanup"
          echo "Cleaning up staging (retention: ${RETENTION_DAYS} days)..."
          echo "Cleanup URL: ${CLEANUP_URL}"

          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST "${CLEANUP_URL}" \
            -H "Content-Type: application/json" \
            -H "x-admin-token: ${ADMIN_TOKEN}" \
            -d "{\"retentionDays\": ${RETENTION_DAYS}}")"

          HTTP_CODE="$(echo "$RESPONSE" | tail -n1)"
          BODY="$(echo "$RESPONSE" | sed '$d')"

          echo "Response: $BODY"
          echo "Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Cleanup failed with status $HTTP_CODE"
            exit 1
          fi

          echo "::notice::Cleanup successful"
